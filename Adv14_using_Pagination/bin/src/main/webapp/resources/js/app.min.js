(function () {
    var useragents = ['android', 'astel', 'audiovox', 'blackberry', 'chtml', 'docomo', 'ericsson', 'hand', 'iphone ', 'ipod', '2me', 'ava', 'j-phone', 'kddi', 'lg', 'midp', 'mini', 'minimo', 'mobi', 'mobile', 'mobileexplorer', 'mot-e', 'motorola', 'mot-v', 'netfront', 'nokia', 'palm', 'palmos', 'palmsource', 'pda', 'pdxgw', 'phone', 'plucker', 'portable', 'portalmmm', 'sagem', 'samsung', 'sanyo', 'sgh', 'sharp', 'sie-m', 'sie-s', 'smartphone', 'softbank', 'sprint', 'symbian', 'telit', 'tsm', 'vodafone', 'wap', 'windowsce', 'wml', 'xiino'];

    var agt = navigator.userAgent.toLowerCase();
    var is_mobile = false;
    for (var i = 0; i < useragents.length; i++) {
        if (agt.indexOf(useragents[i]) != -1) {
            is_mobile = true;
            var user_agent = agt;
            break;
        }
    }

    function getDomainScript() {
        var jsscript = document.getElementsByTagName("script");
        for (var i = 0; i < jsscript.length; i++) {
            var pattern = /jiffyx/i; // the name of your js, whose source you are looking for
            if ( pattern.test( jsscript[i].getAttribute("src") ) ) {
                window.domainScript = jsscript[i].getAttribute("src").replace("/api/app.min.js", "/");
            }
        }
    };

    getDomainScript();

    //create viewport
    var viewPortTag = document.createElement('meta');
    viewPortTag.name = 'viewport';
    viewPortTag.content = 'width=device-width';
    document.getElementsByTagName('head')[0].appendChild(viewPortTag);

    var textBooking = 'Бронирование столов';

    if (typeof jiffyxLang !== "undefined" && jiffyxLang != 'ru') {
        if (jiffyxLang == 'en') {
            textBooking = 'Booking of tables';
        } else if (jiffyxLang == 'ua') {
            textBooking = 'Бронювання столів';
        }
    }

    //create css
    var css = document.createElement('link');
    css.setAttribute('rel', 'stylesheet');
    css.setAttribute('type', 'text/css');
    css.setAttribute('href', domainScript +'api/button.min.css');
    document.body.appendChild(css);

    //create widget button
    if ( typeof jiffyxMainButton == 'undefined' || jiffyxMainButton ) {
        var button = document.createElement('div');
        button.className = "jiffyx-vertical-button";
        button.innerHTML = "<span class='jiffyx-vertical-button-caption'>" + textBooking + "</span>";
        document.body.appendChild(button);
    }

    if (typeof jiffyxStyle !== "undefined") {
        var cssTheme = document.createElement('link');
        cssTheme.setAttribute('rel', 'stylesheet');
        cssTheme.setAttribute('type', 'text/css');
        cssTheme.setAttribute('href', domainScript + 'themes/' + jiffyxStyle + '/button.css');
        document.body.appendChild(cssTheme);
    }

    //get a widget button
    var jiffyx_button = document.getElementsByClassName("jiffyx-vertical-button")[0];
    var jiffyx_show = document.getElementsByClassName("jiffyx_show");

    for (var i = 0; i < jiffyx_show.length; i++) {
        jiffyx_show[i].onclick = function () {
            showJiffys();
        }
    }

    if (typeof jiffyx_button !== "undefined") {
        jiffyx_button.onclick = function () {
            showJiffys();
        };
    }

    function showJiffys(type) {
        var domain = jiffyxDomain;

        getDomainScript();

        if (typeof jiffyxLang !== "undefined" && jiffyxLang != 'ru') {
            domainScript += jiffyxLang;
        }

        if (is_mobile) {
            location.href = domainScript + '?domain=' + domain;
            return false;
        }

        //create wrapper for iframe
        var jiffyx_wrapper = document.createElement('div');
        jiffyx_wrapper.className = "jiffyx-overflow-wrapper";

        if ( type == 'modal' ) {
            var jiffyx_wrapper_mask = document.createElement('div');
            jiffyx_wrapper_mask.className = 'jiffyx-wrapper-mask';

            //add mask and wrapper to body
            document.body.appendChild(jiffyx_wrapper_mask);
            jiffyx_wrapper_mask = document.getElementsByClassName('jiffyx-wrapper-mask')[0];
            jiffyx_wrapper_mask.appendChild(jiffyx_wrapper);
        } else {
            //add wrapper to body
            document.body.appendChild(jiffyx_wrapper);
        }

        //get a wrapper
        var jiffyx_wrapper_element = document.getElementsByClassName("jiffyx-overflow-wrapper")[0];

        //create close button for wrapper
        var jiffyx_wrapper_button_close = document.createElement('div');
        jiffyx_wrapper_button_close.className = "jiffyx-wrapper-button-close";

        //add close button to wrapper
        jiffyx_wrapper_element.appendChild(jiffyx_wrapper_button_close);

        //create iframe
        var iframe = document.createElement('iframe');
        iframe.className = "jiffyx-iframe";
        iframe.setAttribute('src', domainScript + '?domain=' + domain);
        iframe.setAttribute('width', '960');
        iframe.setAttribute('height', '600');
        iframe.setAttribute('name', 'jiffyx_iframe');
        iframe.setAttribute('frameborder', '0');

        //add iframe to wrapper
        jiffyx_wrapper_element.appendChild(iframe);

        //animate wrapper
        setTimeout(function () {
            document.body.classList.add('jiffyx-body-overflow');
            var jiffyx_body_mask = document.getElementsByClassName('jiffyx-body-mask');
            if ( !jiffyx_body_mask.length ) {
                jiffyx_body_mask = document.createElement('div');
                jiffyx_body_mask.className = "jiffyx-body-mask";
                document.body.appendChild(jiffyx_body_mask);
            }
            jiffyx_wrapper_element.classList.add('jiffyx-animate'); //show iframe
        }, 100, function () {
            //hide widget button
            if (typeof jiffyx_button != 'undefined') {
                jiffyx_button.setAttribute('style', 'opacity: 0');
            }
        });

        //get close button
        var jiffyx_wrapper_close_element = document.getElementsByClassName("jiffyx-wrapper-button-close")[0];

        //remove wrapper and show widget button
        jiffyx_wrapper_close_element.onclick = function () {

            //animate wrapper
            jiffyx_wrapper_element.classList.remove('jiffyx-animate');

            setTimeout(function () {
                document.body.classList.remove('jiffyx-body-overflow');

                //show widget button
                if (typeof jiffyx_button != 'undefined') {
                    jiffyx_button.setAttribute('style', 'opacity: 1');
                }

                //remove wrapper
                jiffyx_wrapper_element.remove();
                if ( jiffyx_wrapper_mask != undefined ) {
                    jiffyx_wrapper_mask.remove();
                }
            }, 300);

        };

    };

    //small button
    var small_buttons = document.getElementsByClassName('js-show-jiffyx-widjet-button');
    for ( var i = 0; i < small_buttons.length; i++ ) {
        small_buttons[i].onclick = function () {
            showJiffys('modal');
        }
    }

})();
